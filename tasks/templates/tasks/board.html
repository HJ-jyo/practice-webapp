{% extends 'base.html' %}

{% block content %}
<style>
    /* === レイアウト & デザイン === */
    .p-board-container {
        height: 100%;
        display: flex;
        flex-direction: column;
        background: #f8fafc;
        font-family: 'M PLUS Rounded 1c', sans-serif;
    }

    /* --- タブ切り替えエリア --- */
    .p-tab-area {
        padding: 16px 32px 0;
        display: flex; gap: 24px;
        border-bottom: 2px solid #e2e8f0;
        background: white;
    }
    .c-tab-btn {
        padding: 12px 4px;
        font-weight: 800; font-size: 16px;
        color: var(--text-sub);
        cursor: pointer;
        position: relative;
        transition: 0.2s;
    }
    .c-tab-btn.active {
        color: var(--accent-color);
    }
    .c-tab-btn.active::after {
        content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 3px;
        background: var(--accent-color); border-radius: 3px 3px 0 0;
    }

    /* --- カンバンエリア --- */
    .p-kanban-body {
        flex: 1;
        overflow-x: auto;
        padding: 24px 32px;
        display: flex; gap: 24px;
        align-items: flex-start;
    }

    .c-column {
        flex: 0 0 360px; /* ★ボックスサイズ拡大 */
        min-width: 360px;
        background: #f1f5f9;
        border-radius: 20px;
        padding: 16px;
        display: flex; flex-direction: column;
        max-height: 100%;
    }

    .c-column-header {
        font-weight: 800; font-size: 18px; color: var(--text-main);
        margin-bottom: 16px; padding: 0 8px;
        display: flex; justify-content: space-between; align-items: center;
    }

    .c-task-list {
        flex: 1; overflow-y: auto;
        padding: 4px;
        display: flex; flex-direction: column; gap: 16px; /* カード間隔 */
    }

    /* --- ★タスクカード (大型化 & 詳細表示) --- */
    .c-task-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        cursor: grab;
        border-left: 8px solid #cbd5e1; /* デフォルト色 */
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
    }
    .c-task-card:active { cursor: grabbing; transform: scale(0.98); }
    .c-task-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }

    /* 緊急度カラー */
    .urgency-high { border-left-color: #ef4444 !important; background: #fef2f2; } /* 赤 */
    .urgency-medium { border-left-color: #f59e0b !important; background: #fffbeb; } /* 黄 */
    .urgency-low { border-left-color: #10b981 !important; background: #f0fdf4; } /* 緑 */

    /* コンテンツレイアウト */
    .card-title { font-size: 18px; font-weight: 800; margin-bottom: 8px; line-height: 1.4; }
    .card-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
    
    .limit-badge {
        font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 50px;
        display: inline-flex; align-items: center; gap: 4px;
    }
    .bg-red { background: #fee2e2; color: #ef4444; }
    .bg-yellow { background: #fef3c7; color: #d97706; }
    .bg-green { background: #dcfce7; color: #15803d; }
    .bg-gray { background: #e2e8f0; color: #64748b; }

    /* 進捗バー */
    .progress-track {
        height: 6px; width: 100%; background: #e2e8f0; border-radius: 3px; margin: 12px 0; overflow: hidden;
    }
    .progress-fill { height: 100%; background: var(--accent-color); border-radius: 3px; transition: 0.5s; }

    /* アクションボタン群 */
    .card-actions {
        display: flex; gap: 8px; margin-top: 16px; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 12px;
    }
    .action-btn {
        flex: 1; padding: 8px; font-size: 12px; font-weight: 700; border-radius: 8px;
        border: none; background: #f1f5f9; color: var(--text-sub); cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s;
    }
    .action-btn:hover { background: #e2e8f0; color: var(--text-main); }
    
    /* ステータス変更ボタン */
    .status-changer { display: flex; gap: 4px; }
    .status-btn { width: 32px; height: 32px; border-radius: 50%; border:none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .btn-to-todo { background: #fee2e2; color: #ef4444; }
    .btn-to-doing { background: #fef3c7; color: #d97706; }
    .btn-to-done { background: #dcfce7; color: #15803d; }

    /* === スマホ対応 === */
    @media (max-width: 768px) {
        .p-tab-area { padding: 0 16px; gap: 16px; }
        .c-tab-btn { font-size: 14px; flex: 1; text-align: center; }
        .p-kanban-body { 
            flex-direction: column; /* 縦並びに変更 */
            padding: 16px; gap: 32px;
        }
        .c-column { flex: none; width: 100%; min-width: 0; }
        .c-task-list { overflow: visible; } /* スマホは全体スクロール */
    }
</style>

<div class="p-board-container">
    
    <div class="p-tab-area">
        <div class="c-tab-btn active" onclick="switchTab('all')">すべてのタスク</div>
        <div class="c-tab-btn" onclick="switchTab('personal')">個人タスク</div>
        <div class="c-tab-btn" onclick="switchTab('team')">チームタスク</div>
    </div>

    <div class="p-kanban-body">
        
        <div class="c-column">
            <div class="c-column-header">
                未着手 
                <span style="background:white; padding:2px 10px; border-radius:12px; font-size:14px; color:var(--text-sub);">{{ tasks_todo|length }}</span>
            </div>
            <div class="c-task-list" id="list-todo">
                {% for task in tasks_todo %}
                    {% include "task_card_partial.html" with task=task %}
                {% endfor %}
            </div>
        </div>

        <div class="c-column">
            <div class="c-column-header">
                進行中
                <span style="background:white; padding:2px 10px; border-radius:12px; font-size:14px; color:var(--text-sub);">{{ tasks_doing|length }}</span>
            </div>
            <div class="c-task-list" id="list-doing">
                {% for task in tasks_doing %}
                    {% include "task_card_partial.html" with task=task %}
                {% endfor %}
            </div>
        </div>

        <div class="c-column">
            <div class="c-column-header">
                完了
                <span style="background:white; padding:2px 10px; border-radius:12px; font-size:14px; color:var(--text-sub);">{{ tasks_done|length }}</span>
            </div>
            <div class="c-task-list" id="list-done">
                {% for task in tasks_done %}
                    {% include "task_card_partial.html" with task=task %}
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<script>
    // === 1. Ajax タスク移動 ===
    function moveTask(taskId, newStatus) {
        const csrfToken = '{{ csrf_token }}';
        
        fetch("{% url 'api_move_task' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ task_id: taskId, status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                // 成功したら画面をリロードして反映（本格的なSPA化はさらに複雑になるため今回はリロード）
                location.reload(); 
            } else {
                alert('エラーが発生しました');
            }
        });
    }

    // === 2. Googleカレンダー追加 ===
    function addToGoogleCalendar(title, dateStr, desc) {
        if (!dateStr) { alert('期限が設定されていません'); return; }
        
        // 日付整形 (YYYYMMDD)
        const dateObj = new Date(dateStr);
        const yyyy = dateObj.getFullYear();
        const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
        const dd = String(dateObj.getDate()).padStart(2, '0');
        const dateFmt = `${yyyy}${mm}${dd}`;
        
        // リンク生成
        const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${dateFmt}/${dateFmt}&details=${encodeURIComponent(desc)}`;
        window.open(url, '_blank');
    }

    // === 3. 招待リンクコピー ===
    function copyInviteLink(taskId) {
        // 簡易的な招待リンク（本来は専用のトークンURLを発行すべき）
        const url = `${window.location.origin}/task/${taskId}/edit/`; 
        navigator.clipboard.writeText(url).then(() => {
            alert('招待用リンクをコピーしました！\n相手にこのURLを送ってください。');
        });
    }

    // === 4. タブ切り替え（簡易フィルタ） ===
    function switchTab(type) {
        // ボタンのアクティブ切り替え
        document.querySelectorAll('.c-tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        const cards = document.querySelectorAll('.c-task-card');
        cards.forEach(card => {
            const isPersonal = card.dataset.isPersonal === 'true';
            
            if (type === 'all') {
                card.style.display = 'block';
            } else if (type === 'personal') {
                card.style.display = isPersonal ? 'block' : 'none';
            } else if (type === 'team') {
                card.style.display = !isPersonal ? 'block' : 'none';
            }
        });
    }
</script>
{% endblock %}