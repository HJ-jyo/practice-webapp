{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="p-view-header">
    <div style="display:flex; align-items:center; gap:5px;">
        <span class="p-channel-name"># ボード</span>
        <i class="bi bi-star" style="font-size:14px; color:#616061; margin-left:5px;"></i>
    </div>
    <div class="p-header-meta">
        <i class="bi bi-people"></i> メンバー: {{ request.user.username }}
    </div>
</div>

<div class="p-view-body">
    
    {% if messages %}
        {% for message in messages %}
        <div style="background:#d1f2eb; color:#0e5a48; padding:10px; border-radius:8px; margin-bottom:20px; font-size:14px; border:1px solid #bce6dd;">
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}

    <div class="p-kanban-board">
        
        <div class="c-column">
            <div class="c-column-header">
                <i class="bi bi-circle-fill" style="color:var(--status-todo); font-size:12px;"></i>
                未着手
                <span style="color:#616061; font-weight:400; font-size:13px; margin-left:4px;">{{ tasks_todo.count }}</span>
            </div>
            <div>
                {% for task in tasks_todo %}
                    <div class="c-task-card" onclick="location.href='{% url 'task_edit' task.pk %}'">
                        <div class="c-task-title">{{ task.title }}</div>
                        {% if task.category %}<span class="c-badge">{{ task.category.name }}</span>{% endif %}
                        <div class="c-task-meta">
                            <span>期限: {{ task.due_date|date:"m/d"|default:"-" }}</span>
                            <form action="{% url 'move_to_doing' task.pk %}" method="post" style="display:inline;">{% csrf_token %}
                                <button type="submit" style="background:none; border:none; color:#1264a3; font-weight:bold; font-size:12px; cursor:pointer;">
                                    開始する
                                </button>
                            </form>
                        </div>
                    </div>
                {% empty %}
                    <div style="text-align:center; color:#616061; padding:20px; font-size:13px;">タスクはありません</div>
                {% endfor %}
            </div>
        </div>

        <div class="c-column">
            <div class="c-column-header">
                <i class="bi bi-circle-fill" style="color:var(--status-doing); font-size:12px;"></i>
                進行中
                <span style="color:#616061; font-weight:400; font-size:13px; margin-left:4px;">{{ tasks_doing.count }}</span>
            </div>
            <div>
                {% for task in tasks_doing %}
                    <div class="c-task-card" onclick="location.href='{% url 'task_edit' task.pk %}'">
                        <div class="c-task-title">{{ task.title }}</div>
                        {% if task.category %}<span class="c-badge">{{ task.category.name }}</span>{% endif %}
                        <div class="c-task-meta">
                            <span style="color:var(--status-doing);">進行中...</span>
                            <form action="{% url 'move_to_done' task.pk %}" method="post" style="display:inline;">{% csrf_token %}
                                <button type="submit" style="background:none; border:none; color:#007a5a; font-weight:bold; font-size:12px; cursor:pointer;">
                                    完了にする
                                </button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="c-column">
            <div class="c-column-header">
                <i class="bi bi-check-circle-fill" style="color:var(--status-done); font-size:12px;"></i>
                完了
                <span style="color:#616061; font-weight:400; font-size:13px; margin-left:4px;">{{ tasks_done.count }}</span>
                {% if tasks_done.count > 0 %}
                    <form action="{% url 'delete_done_tasks' %}" method="post" style="margin-left:auto;">{% csrf_token %}
                        <button type="submit" style="border:none; background:none; color:#616061; cursor:pointer;" title="完了を一括削除">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                {% endif %}
            </div>
            <div>
                {% for task in tasks_done %}
                    <div class="c-task-card" style="opacity:0.7; background:#F8F8F8;">
                        <div class="c-task-title" style="text-decoration:line-through; color:#616061;">{{ task.title }}</div>
                        <div class="c-task-meta">
                            <span><i class="bi bi-check2-all"></i> 完了済</span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

    </div>
</div>
{% endblock %}