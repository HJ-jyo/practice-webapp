{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç´„É≥„Éê„É≥„Éú„Éº„Éâ</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>

    <div class="app-wrapper">

        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="bi bi-kanban-fill text-primary"></i>
                <span class="brand-name">Kanban</span>
            </div>

            <div class="user-profile-mini">
                <div class="avatar-circle">{{ user.username|slice:":1" }}</div>
                <div class="user-info">
                    <span class="username">{{ user.username }}</span>
                    <a href="{% url 'profile' %}" class="profile-link">„Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ</a>
                </div>
            </div>

            <nav class="sidebar-nav">
                <a href="{% url 'board' %}" class="nav-item active">
                    <i class="bi bi-grid-1x2-fill"></i> „Éú„Éº„Éâ
                </a>
                <a href="{% url 'invitation_list' %}" class="nav-item">
                    <i class="bi bi-envelope-fill"></i> „É°„ÉÉ„Çª„Éº„Ç∏
                    </a>
                <a href="{% url 'task_create' %}" class="nav-item">
                    <i class="bi bi-plus-square-fill"></i> Êñ∞Ë¶è„Çø„Çπ„ÇØ
                </a>
                <button onclick="copyProgress()" class="nav-item btn-reset">
                    <i class="bi bi-clipboard-data-fill"></i> ÈÄ≤Êçó„Ç≥„Éî„Éº
                </button>
            </nav>

            <div class="sidebar-footer">
                <form action="{% url 'logout' %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="logout-btn">
                        <i class="bi bi-box-arrow-left"></i> „É≠„Ç∞„Ç¢„Ç¶„Éà
                    </button>
                </form>
            </div>
        </aside>

        <main class="main-content">
            
            <header class="content-header">
                <div>
                    <h1 class="page-title">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h1>
                    <p class="text-muted small mb-0">{{ now|date:"YÂπ¥nÊúàjÊó•" }} „ÅÆÁä∂Ê≥Å</p>
                </div>
                
                <form method="get" class="search-form">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" name="q" placeholder="„Çø„Çπ„ÇØ„ÇíÊ§úÁ¥¢..." value="{{ query|default:'' }}">
                    {% if query or selected_category_id %}
                        <a href="{% url 'board' %}" class="reset-search"><i class="bi bi-x-circle-fill"></i></a>
                    {% endif %}
                </form>
            </header>

            {% if messages %}
            <div class="alert-area">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show border-0 shadow-sm" role="alert">
                    <i class="bi bi-info-circle-fill me-2"></i>{{ message|safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="dashboard-grid">
                
                <div class="bento-card summary-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold text-secondary mb-0">ÂÖ®‰Ωì„ÅÆÈÄ≤Êçó</h6>
                        <span class="badge bg-primary rounded-pill">{{ progress_percent }}% ÂÆå‰∫Ü</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar" role="progressbar" style="width: {{ progress_percent }}%"></div>
                    </div>
                    <div class="mt-3 d-flex gap-2 overflow-auto">
                        <a href="{% url 'board' %}" class="cat-pill {% if not selected_category_id %}active{% endif %}">„Åô„Åπ„Å¶</a>
                        {% for cat in categories %}
                            <a href="?category={{ cat.id }}" class="cat-pill {% if selected_category_id == cat.id %}active{% endif %}">
                                {{ cat.name }}
                            </a>
                        {% endfor %}
                    </div>
                </div>

                <div class="kanban-wrapper">
                    <div class="row g-4 h-100">
                        
                        <div class="col-md-4 h-100">
                            <div class="kanban-col col-todo">
                                <div class="col-header">
                                    <span class="status-dot dot-todo"></span>
                                    <span>Êú™ÁùÄÊâã</span>
                                    <span class="count-badge">{{ tasks_todo.count }}</span>
                                </div>
                                <div class="col-body" id="collapseTodo">
                                    {% for task in tasks_todo %}
                                        {% include "tasks/card_snippet.html" with task=task color="danger" btn_color="outline-danger" btn_text="ÈñãÂßã" next_url="move_to_doing" %}
                                    {% empty %}
                                        <div class="empty-state">No Tasks</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 h-100">
                            <div class="kanban-col col-doing">
                                <div class="col-header">
                                    <span class="status-dot dot-doing"></span>
                                    <span>ÈÄ≤Ë°å‰∏≠</span>
                                    <span class="count-badge">{{ tasks_doing.count }}</span>
                                </div>
                                <div class="col-body" id="collapseDoing">
                                    {% for task in tasks_doing %}
                                        {% include "tasks/card_snippet.html" with task=task color="warning" btn_color="outline-warning" btn_text="ÂÆå‰∫Ü" next_url="move_to_done" %}
                                    {% empty %}
                                        <div class="empty-state">No Tasks</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 h-100">
                            <div class="kanban-col col-done">
                                <div class="col-header">
                                    <span class="status-dot dot-done"></span>
                                    <span>ÂÆå‰∫Ü</span>
                                    <span class="count-badge">{{ tasks_done.count }}</span>
                                    {% if tasks_done.count > 0 %}
                                    <form action="{% url 'delete_done_tasks' %}" method="post" class="ms-auto" onsubmit="return confirm('ÂÆå‰∫Ü„Çø„Çπ„ÇØ„Çí‰∏ÄÊã¨ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü');">
                                        {% csrf_token %}
                                        <button type="submit" class="trash-btn"><i class="bi bi-trash"></i></button>
                                    </form>
                                    {% endif %}
                                </div>
                                <div class="col-body" id="collapseDone">
                                    {% for task in tasks_done %}
                                        {% include "tasks/card_snippet.html" with task=task color="success" is_done=True %}
                                    {% empty %}
                                        <div class="empty-state">Good Job!</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function copyProgress() {
            // (JS„É≠„Ç∏„ÉÉ„ÇØ„ÅØÂ§âÊõ¥„Å™„Åó„ÅßOK)
            const now = new Date();
            const dateStr = now.toLocaleDateString() + " " + now.toLocaleTimeString().slice(0, -3);
            function getTaskTitles(containerId) {
                const container = document.getElementById(containerId);
                if(!container) return { count: 0, text: "Ôºà„Å™„ÅóÔºâ\n" };
                const titles = container.querySelectorAll('.task-title');
                let list = "";
                titles.forEach(el => { list += "„Éª" + el.textContent.trim() + "\n"; });
                if (titles.length === 0) list = "Ôºà„Å™„ÅóÔºâ\n";
                return { count: titles.length, text: list };
            }
            const todo = getTaskTitles('collapseTodo');
            const doing = getTaskTitles('collapseDoing');
            const done = getTaskTitles('collapseDone');
            const reportText = `„ÄêÈÄ≤ÊçóÂ†±Âëä„Äë ${dateStr}\n\nüî¥ Êú™ÁùÄÊâã: ${todo.count}‰ª∂\n${todo.text}\nüü° ÈÄ≤Ë°å‰∏≠: ${doing.count}‰ª∂\n${doing.text}\nüü¢ ÂÆå‰∫Ü: ${done.count}‰ª∂\n${done.text}`;
            navigator.clipboard.writeText(reportText).then(() => { alert("ÈÄ≤Êçó„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ"); });
        }
    </script>
</body>
</html>