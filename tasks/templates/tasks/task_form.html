{% extends 'base.html' %}

{% block content %}
<style>
    /* === ページ全体 === */
    .detail-container {
        /* 幅いっぱいに使う */
        width: 100%;
        height: 100vh; /* 画面高さいっぱい */
        overflow: hidden;
        background: #f1f5f9;
        display: flex;
        flex-direction: column;
    }

    /* ヘッダー */
    .detail-header {
        padding: 16px 24px;
        background: white;
        border-bottom: 1px solid #e2e8f0;
        display: flex; justify-content: space-between; align-items: center;
        flex-shrink: 0;
    }

    /* === 3カラムレイアウト (PC) === */
    .three-col-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 280px; /* 左:入力, 中:チャット, 右:メンバー */
        height: 100%;
        overflow: hidden;
    }

    /* === カラム1: タスク入力 (左) === */
    .col-input {
        padding: 30px;
        overflow-y: auto;
        border-right: 1px solid #e2e8f0;
        background: white;
    }
    .col-input label { font-weight: 800; color: var(--text-main); margin-bottom: 8px; display: block; }
    .col-input textarea { min-height: 300px; resize: vertical; padding: 16px; line-height: 1.6; }
    .col-input input[type="text"] { font-size: 18px; font-weight: 700; padding: 14px; }
    
    /* === カラム2: チャット (中央) === */
    .col-chat {
        display: flex; flex-direction: column;
        background: #f8fafc;
        border-right: 1px solid #e2e8f0;
        overflow: hidden;
    }
    .chat-header {
        padding: 16px; border-bottom: 1px solid #e2e8f0; font-weight: 800; color: var(--text-sub);
        background: #f8fafc;
    }
    .chat-scroll {
        flex: 1; overflow-y: auto; padding: 20px;
        display: flex; flex-direction: column; gap: 16px;
    }
    .chat-input-area {
        padding: 16px; background: white; border-top: 1px solid #e2e8f0;
    }
    
    /* チャット吹き出し */
    .chat-bubble { display: flex; gap: 10px; }
    .chat-avatar { width: 32px; height: 32px; border-radius: 50%; background: #cbd5e1; overflow: hidden; flex-shrink: 0; }
    .chat-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .chat-content { flex: 1; }
    .chat-meta { font-size: 11px; color: var(--text-sub); margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
    .chat-text { 
        background: white; padding: 10px 14px; border-radius: 4px 14px 14px 14px; 
        font-size: 14px; color: var(--text-main); line-height: 1.5;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    /* === カラム3: メンバーリスト (右・Discord風) === */
    .col-members {
        background: #1e293b; /* Discordっぽい暗色背景 */
        color: #e2e8f0;
        display: flex; flex-direction: column;
        overflow-y: auto;
    }
    .member-header {
        padding: 16px;
        font-size: 12px; font-weight: 800; color: #94a3b8; letter-spacing: 0.5px;
        border-bottom: 1px solid #334155;
    }
    
    /* ステータスグループ */
    .status-group { margin-bottom: 24px; padding: 0 12px; }
    .status-label {
        font-size: 11px; font-weight: 800; color: #94a3b8; margin: 16px 0 8px 8px;
        text-transform: uppercase;
    }
    
    /* メンバー行 */
    .discord-member {
        display: flex; align-items: center; gap: 10px;
        padding: 8px; border-radius: 6px;
        transition: 0.2s; cursor: default;
    }
    .discord-member:hover { background: rgba(255,255,255,0.05); }
    
    .dm-avatar {
        width: 32px; height: 32px; border-radius: 50%; background: #475569; position: relative;
    }
    .dm-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
    
    /* ステータスバッジ（アイコンの右下に丸ポチ） */
    .dm-status-dot {
        position: absolute; bottom: -2px; right: -2px; width: 12px; height: 12px;
        border-radius: 50%; border: 2px solid #1e293b;
    }
    .dot-todo { background: #ef4444; }   /* 赤 */
    .dot-doing { background: #f59e0b; }  /* 黄 */
    .dot-done { background: #10b981; }   /* 緑 */

    .dm-info { flex: 1; min-width: 0; }
    .dm-name { font-size: 14px; font-weight: 600; color: #f1f5f9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .dm-sub { font-size: 11px; color: #94a3b8; }

    /* 自分用ステータス変更ボタン */
    .status-actions {
        display: flex; gap: 4px; margin-top: 4px;
    }
    .sa-btn {
        width: 20px; height: 20px; border-radius: 4px; border: none; cursor: pointer;
        display: flex; align-items: center; justify-content: center; font-size: 10px; color: rgba(0,0,0,0.6);
        transition: 0.2s;
    }
    .sa-btn:hover { transform: scale(1.1); }
    .sa-todo { background: #ef4444; }
    .sa-doing { background: #f59e0b; }
    .sa-done { background: #10b981; }

    /* スマホ対応 */
    @media (max-width: 900px) {
        .detail-container { height: auto; overflow: visible; }
        .three-col-grid { display: flex; flex-direction: column; height: auto; overflow: visible; }
        .col-input { order: 1; border-right: none; border-bottom: 1px solid #e2e8f0; }
        .col-members { order: 2; height: 400px; } /* スマホではメンバーを次に表示 */
        .col-chat { order: 3; height: 500px; border-right: none; }
    }
</style>

<div class="detail-container">
    
    <div class="detail-header">
        <div style="display: flex; align-items: center; gap: 12px;">
            <a href="{% url 'board' %}" style="width:36px; height:36px; border-radius:50%; background:#f1f5f9; display:flex; align-items:center; justify-content:center; color:var(--text-main);">
                <i class="bi bi-arrow-left"></i>
            </a>
            <h2 style="font-size: 18px; font-weight: 800; margin: 0;">
                {% if form.instance.pk %}タスク詳細{% else %}新規作成{% endif %}
            </h2>
        </div>
        
        {% if form.instance.pk %}
        <div style="display:flex; gap:12px;">
            <button type="button" onclick="copyUrl()" class="btn" style="padding: 8px 16px; font-size: 13px; background: #eff6ff; color: var(--accent-color); box-shadow:none;">
                <i class="bi bi-link-45deg"></i> 招待リンク
            </button>
            <a href="{% url 'task_delete' form.instance.pk %}" class="btn-danger" style="padding: 8px 16px; font-size: 13px; border-radius:50px; text-decoration:none;" onclick="return confirm('削除しますか？')">
                <i class="bi bi-trash"></i>
            </a>
        </div>
        {% endif %}
    </div>

    <div class="three-col-grid">
        
        <div class="col-input">
            <form method="post">
                {% csrf_token %}
                <div style="margin-bottom: 24px;">
                    <label>タイトル</label>
                    {{ form.title }}
                </div>
                <div style="margin-bottom: 24px;">
                    <label>詳細・メモ</label>
                    {{ form.description }}
                </div>
                <div style="margin-bottom: 32px;">
                    <label>期限</label>
                    {{ form.due_date }}
                </div>
                <div style="text-align: right;">
                    <button type="submit" class="btn"><i class="bi bi-save"></i> 変更を保存</button>
                </div>
            </form>
        </div>

        {% if form.instance.pk %}
        <div class="col-chat">
            <div class="chat-header">
                <i class="bi bi-chat-dots"></i> チームチャット
            </div>
            <div class="chat-scroll" id="chatScroll">
                {% for comment in form.instance.comments.all %}
                <div class="chat-bubble">
                    <div class="chat-avatar">
                        {% if comment.user.profile.icon %}<img src="{{ comment.user.profile.icon.url }}">{% else %}{{ comment.user.username|slice:":1" }}{% endif %}
                    </div>
                    <div class="chat-content">
                        <div class="chat-meta">
                            <strong>{{ comment.user.username }}</strong>
                            <span>{{ comment.created_at|date:"m/d H:i" }}</span>
                        </div>
                        <div class="chat-text">{{ comment.content|linebreaksbr }}</div>
                    </div>
                </div>
                {% empty %}
                <div style="text-align:center; color:#94a3b8; font-size:13px; margin-top:40px;">
                    メッセージはまだありません
                </div>
                {% endfor %}
            </div>
            <div class="chat-input-area">
                <form action="{% url 'add_comment' form.instance.pk %}" method="post" style="display: flex; gap: 10px;">
                    {% csrf_token %}
                    <input type="text" name="content" placeholder="メッセージ..." required style="border: 2px solid #e2e8f0; border-radius: 50px;">
                    <button type="submit" class="btn-icon-circle" style="background: var(--accent-color); color: white; width:44px; height:44px;">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </form>
            </div>
        </div>

        <div class="col-members">
            <div class="member-header">MEMBERS</div>
            
            <div class="status-group">
                <div class="status-label">完了 — {{ done_members|length }}</div>
                {% for assign in form.instance.taskassignment_set.all %}
                    {% if assign.status == 'done' %}
                        {% include "tasks/member_row.html" with assign=assign %}
                    {% endif %}
                {% endfor %}
            </div>

            <div class="status-group">
                <div class="status-label">進行中 — {{ doing_members|length }}</div>
                {% for assign in form.instance.taskassignment_set.all %}
                    {% if assign.status == 'doing' %}
                        {% include "tasks/member_row.html" with assign=assign %}
                    {% endif %}
                {% endfor %}
            </div>

            <div class="status-group">
                <div class="status-label">未着手 — {{ todo_members|length }}</div>
                {% for assign in form.instance.taskassignment_set.all %}
                    {% if assign.status == 'todo' %}
                        {% include "tasks/member_row.html" with assign=assign %}
                    {% endif %}
                {% endfor %}
            </div>

            <div style="padding:16px; margin-top:auto; border-top:1px solid #334155;">
                <form action="{% url 'invite_user' form.instance.pk %}" method="post" style="display:flex; gap:6px;">
                    {% csrf_token %}
                    <input type="text" name="username" placeholder="IDで招待" style="background:#0f172a; border:none; color:white; padding:8px; border-radius:4px; font-size:12px;">
                    <button type="submit" style="background:#3b82f6; border:none; color:white; border-radius:4px; width:30px; cursor:pointer;"><i class="bi bi-plus-lg"></i></button>
                </form>
            </div>
        </div>
        {% else %}
        <div style="background:#f8fafc; grid-column: 2 / -1; display:flex; align-items:center; justify-content:center; color:#94a3b8;">
            タスク作成後にチャットとメンバー機能が使えます
        </div>
        {% endif %}

    </div>
</div>

<script>
    function copyUrl() {
        navigator.clipboard.writeText(window.location.href).then(() => alert('リンクをコピーしました'));
    }
    
    // 自分のステータスを変更する
    function changeMyStatus(taskId, status) {
        fetch("{% url 'api_update_status' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ task_id: taskId, status: status })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') location.reload();
        });
    }

    // チャット最下部へスクロール
    window.onload = function() {
        const chat = document.getElementById('chatScroll');
        if(chat) chat.scrollTop = chat.scrollHeight;
    }
</script>
{% endblock %}